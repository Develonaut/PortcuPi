var request=require("request"),parseString=require("xml2js").parseString,_=require("underscore"),fs=require("fs"),helper_path="../min/",xml_helper=require(helper_path+"xml_helpers-min.js"),cache_helper=require(helper_path+"cache_helpers-min.js"),db_helper_vars={temp_path_url:"public/images/temp/",base_image_url:"http://thegamesdb.net/banners/"};module.exports={getGameList:function(e,t){request("http://thegamesdb.net/api/GetGamesList.php?name="+e,function(e,a,r){var n=null;e||200!=a.statusCode||(parseString(r,function(e,t){_.isEmpty(t.Error)&&!_.isEmpty(t.Data.Game)?n=t.Data.Game:console.log("Something went wrong in the game list call.")}),t(n))})},getPlatformSpecifiedGameList:function(e,t,a){var r="http://thegamesdb.net/api/GetGamesList.php?",n="name="+t,s="&platform="+e,i=r+n+s;request(i,function(e,t,r){var n=null;e||200!=t.statusCode||(parseString(r,function(e,t){_.isEmpty(t.Error)&&!_.isEmpty(t.Data.Game)?n=t.Data.Game:console.log("Something went wrong in the platform game list call.")}),a(n))})},getPlatformList:function(e){try{cached_file_name="PlatformList",cache_helper.checkCachedData(cached_file_name,function(t){_.isEmpty(t)?request("http://thegamesdb.net/api/GetPlatformsList.php",function(t,a,r){var n=null;t||200!=a.statusCode||(parseString(r,function(e,t){_.isEmpty(t.Error)&&!_.isEmpty(t.Data.Platforms)?(n=t.Data.Platforms[0].Platform,cache_helper.writeToCache(cached_file_name,n)):console.log("Something went wrong in the get platform list call.")}),console.log("Sending back api data."),e(n))}):(console.log("Sending back cached data."),e(t))})}catch(t){console.log(t)}},getGame:function(e,t){request("http://thegamesdb.net/api/GetGame.php?id="+e,function(e,a,r){var n=null;e||200!=a.statusCode||(parseString(r,function(e,t){if(_.isEmpty(t.Error)&&!_.isEmpty(t.Data.Game)){n=t.Data.Game,n.XML=xml_helper.buildXML(t.Data.Game);var a=n[0],r={},s=_.has(a,"Images");if(game_has_boxart=_.has(a.Images[0],"boxart"),s&&game_has_boxart){var i=a.Images[0].boxart;_.isEmpty(i[0])||(r.front=i[0].$,a.BoxArt=[r]),_.isEmpty(i[1])||(r.front=i[1].$,r.back=i[0].$,a.BoxArt=[r])}var o="",m=_.has(a,"Genres");m&&(o=a.Genres[0].genre[0],a.Genres=[o])}else console.log("Something went wrong in the get game call.")}),t(n))})}};