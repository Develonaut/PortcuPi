var request=require("request"),parseString=require("xml2js").parseString,_=require("underscore"),fs=require("fs"),helper_path="../min/",xml_helper=require(helper_path+"xml_helpers-min.js"),cache_helper=require(helper_path+"cache_helpers-min.js"),db_helper_vars={temp_path_url:"public/images/temp/",base_image_url:"http://thegamesdb.net/banners/"};module.exports={getGameList:function(e,t){request("http://thegamesdb.net/api/GetGamesList.php?name="+e,function(a,r,s){var n={game_name:null,results:null};a||200!=r.statusCode||(parseString(s,function(t,a){_.isEmpty(a.Error)&&!_.isEmpty(a.Data.Game)?(n.game_name=e,n.results=a.Data.Game):console.log("Something went wrong in the game list call.")}),t(n))})},getPlatformSpecifiedGameList:function(e,t,a){var r="http://thegamesdb.net/api/GetGamesList.php?",s="name="+t,n="&platform="+e,i=r+s+n;request(i,function(r,s,n){var i={allow_game_search:null,game_name:null,game_platform:null,results:null};r||200!=s.statusCode||(parseString(n,function(a,r){_.isEmpty(r.Error)&&!_.isEmpty(r.Data.Game)?(i.game_name=t,i.game_platform=e,i.results=r.Data.Game):(i.game_name=t,i.allow_game_search=!0,console.log("Something went wrong in the platform game list call."))}),a(i))})},getPlatformList:function(e){try{cached_file_name="PlatformList",cache_helper.checkCachedData(cached_file_name,function(t){_.isEmpty(t)?request("http://thegamesdb.net/api/GetPlatformsList.php",function(t,a,r){var s=null;t||200!=a.statusCode||(parseString(r,function(e,t){_.isEmpty(t.Error)&&!_.isEmpty(t.Data.Platforms)?(s=t.Data.Platforms[0].Platform,cache_helper.writeToCache(cached_file_name,s)):console.log("Something went wrong in the get platform list call.")}),console.log("Sending back api data."),e(s))}):(console.log("Sending back cached data."),e(t))})}catch(t){console.log(t)}},getGame:function(e,t){request("http://thegamesdb.net/api/GetGame.php?id="+e,function(e,a,r){var s=null;e||200!=a.statusCode||(parseString(r,function(e,t){if(_.isEmpty(t.Error)&&!_.isEmpty(t.Data.Game)){s=t.Data.Game,s.XML=xml_helper.buildXML(t.Data.Game);var a=s[0],r={},n=_.has(a,"Images");if(game_has_boxart=_.has(a.Images[0],"boxart"),n&&game_has_boxart){var i=a.Images[0].boxart;if(!_.isEmpty(i[0])){var l=i[0].$.width/2,m=i[0].$.height/2;i[0].$.adjusted_height=m,i[0].$.adjusted_height=l,r.front=i[0].$,a.BoxArt=[r]}if(!_.isEmpty(i[1])){var l=i[1].$.width/2,m=i[1].$.height/2;i[1].$.adjusted_height=m,i[1].$.adjusted_width=l;var l=i[0].$.width/2,m=i[0].$.height/2;i[0].$.adjusted_height=m,i[0].$.adjusted_width=l,console.log(i[1].$),console.log(i[0].$),r.front=i[1].$,r.back=i[0].$,a.BoxArt=[r]}}var o="",h=_.has(a,"Genres");h&&(o=a.Genres[0].genre[0],a.Genres=[o])}else console.log("Something went wrong in the get game call.")}),t(s))})}};