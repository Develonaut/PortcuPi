var request=require("request"),parseString=require("xml2js").parseString,_=require("underscore"),fs=require("fs"),helper_path="../min/",xml_helper=require(helper_path+"xml_helpers-min.js"),cache_helper=require(helper_path+"cache_helpers-min.js"),db_helper_vars={temp_path_url:"public/images/temp/",base_image_url:"http://thegamesdb.net/banners/"};module.exports={getGameList:function(e,a){request("http://thegamesdb.net/api/GetGamesList.php?name="+e,function(t,r,n){var s={game_name:null,results:null};t||200!=r.statusCode||(parseString(n,function(a,t){_.isEmpty(t.Error)&&!_.isEmpty(t.Data.Game)?(s.game_name=e,s.results=t.Data.Game):console.log("Something went wrong in the game list call.")}),a(s))})},getPlatformSpecifiedGameList:function(e,a,t){var r="http://thegamesdb.net/api/GetGamesList.php?",n="name="+a,s="&platform="+e,l=r+n+s;request(l,function(r,n,s){var l={allow_game_search:null,game_name:null,game_platform:null,results:null};r||200!=n.statusCode||(parseString(s,function(t,r){_.isEmpty(r.Error)&&!_.isEmpty(r.Data.Game)?(l.game_name=a,l.game_platform=e,l.results=r.Data.Game):(l.game_name=a,l.allow_game_search=!0,console.log("Something went wrong in the platform game list call."))}),t(l))})},getPlatformList:function(e){try{cached_file_name="PlatformList",cache_helper.checkCachedData(cached_file_name,function(a){_.isEmpty(a)?request("http://thegamesdb.net/api/GetPlatformsList.php",function(a,t,r){var n=null;a||200!=t.statusCode||(parseString(r,function(e,a){_.isEmpty(a.Error)&&!_.isEmpty(a.Data.Platforms)?(n=a.Data.Platforms[0].Platform,cache_helper.writeToCache(cached_file_name,n)):console.log("Something went wrong in the get platform list call.")}),console.log("Sending back api data."),e(n))}):(console.log("Sending back cached data."),e(a))})}catch(a){console.log(a)}},getGame:function(e,a){request("http://thegamesdb.net/api/GetGame.php?id="+e,function(e,t,r){var n=null;e||200!=t.statusCode||(parseString(r,function(e,a){if(_.isEmpty(a.Error)&&!_.isEmpty(a.Data.Game)){n=a.Data.Game,n.XML=xml_helper.buildXML(a.Data.Game);var t=n[0],r={},s=_.has(t,"Images");if(game_has_boxart=_.has(t.Images[0],"boxart"),s&&game_has_boxart){var l=t.Images[0].boxart;_.isEmpty(l[0])||(r.front=l[0].$,t.BoxArt=[r]),_.isEmpty(l[1])||(r.front=l[1].$,r.back=l[0].$,t.BoxArt=[r])}var m="",i=_.has(t,"Genres");i&&(m=t.Genres[0].genre[0],t.Genres=[m])}else console.log("Something went wrong in the get game call.")}),a(n))})}};