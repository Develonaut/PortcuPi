var request=require("request"),parseString=require("xml2js").parseString,_=require("underscore"),fs=require("fs"),helper_path="../min/",xml_helper=require(helper_path+"xml_helpers-min.js"),cache_helper=require(helper_path+"cache_helpers-min.js"),db_helper_vars={temp_path_url:"public/images/temp/",base_image_url:"http://thegamesdb.net/banners/"};module.exports={getGameList:function(e,t){request("http://thegamesdb.net/api/GetGamesList.php?name="+e,function(e,a,r){var s=null;e||200!=a.statusCode?t("getGameList error"):(parseString(r,function(e,t){s=t.Data.Game}),t(s))})},getPlatformSpecifiedGameList:function(e,t,a){var r="http://thegamesdb.net/api/GetGamesList.php?",s="name="+t,n="&platform="+e,i=r+s+n;request(i,function(e,t,r){var s=null;e||200!=t.statusCode?a("getGameList error"):(parseString(r,function(e,t){s=t.Data.Game}),a(s))})},getPlatformList:function(e){try{cached_file_name="PlatformList",cache_helper.checkCachedData(cached_file_name,function(t){_.isEmpty(t)?request("http://thegamesdb.net/api/GetPlatformsList.php",function(t,a,r){var s=null;t||200!=a.statusCode?e("getPlatformList Error"):(parseString(r,function(e,t){s=t.Data.Platforms[0].Platform}),cache_helper.writeToCache(cached_file_name,s),console.log("Sending back api data."),e(s))}):(console.log("Sending back cached data."),e(t))})}catch(t){console.log(t)}},getGame:function(e,t){request("http://thegamesdb.net/api/GetGame.php?id="+e,function(e,a,r){var s=null;if(e||200!=a.statusCode)t("getGame Error");else{parseString(r,function(e,t){s=t.Data.Game,s.XML=xml_helper.buildXML(t.Data.Game)});var n=s[0],i={},m=_.has(n,"Images");if(game_has_boxart=_.has(n.Images[0],"boxart"),m&&game_has_boxart){var o=n.Images[0].boxart;_.isEmpty(o[0])||(i.front=o[0].$,n.BoxArt=[i]),_.isEmpty(o[1])||(i.front=o[1].$,i.back=o[0].$,n.BoxArt=[i])}var p="",h=_.has(n,"Genres");h&&(p=n.Genres[0].genre[0],n.Genres=[p]),t(s)}})}};